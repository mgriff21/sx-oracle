<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SX Oracle â€” 2026 Supercross Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ RESET & BASE â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; -webkit-text-size-adjust: 100%; }
body {
  font-family: 'Barlow Condensed', sans-serif;
  background: linear-gradient(155deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
  color: #e0e0e0;
}

/* â”€â”€â”€ APP SHELL â”€â”€â”€ */
#app {
  display: flex; flex-direction: column; height: 100%;
  max-width: 500px; margin: 0 auto;
  position: relative;
}

/* â”€â”€â”€ ACCENT BAR â”€â”€â”€ */
#accent-bar {
  position: absolute; top: 0; left: 0; right: 0; height: 3px; z-index: 100;
  background: linear-gradient(90deg, #e63946, #ff6b35, #f7c948, #06d6a0, #118ab2);
}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header {
  flex-shrink: 0; padding: 18px 20px 10px;
  display: flex; justify-content: space-between; align-items: flex-end;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  z-index: 10;
}
.logo h1 {
  font-family: 'Bebas Neue', sans-serif; font-size: 26px;
  letter-spacing: 3px; color: #f7c948; line-height: 1;
}
.logo p {
  font-size: 11px; font-weight: 300; letter-spacing: 2px;
  color: #666; text-transform: uppercase;
}
.round-badge { text-align: right; }
.round-badge .rnum {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: #e63946; font-weight: 600;
}
.round-badge .rname {
  font-family: 'Bebas Neue', sans-serif; font-size: 18px;
  letter-spacing: 3px; color: #fff;
}

/* â”€â”€â”€ PULL BAR â”€â”€â”€ */
#pull-bar {
  flex-shrink: 0; padding: 8px 16px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  background: rgba(255,255,255,0.015);
}
#pull-btn {
  background: linear-gradient(135deg, rgba(247,201,72,0.15), rgba(247,201,72,0.05));
  border: 1px solid rgba(247,201,72,0.3); color: #f7c948;
  padding: 8px 14px; border-radius: 6px; cursor: pointer;
  font-family: 'Barlow Condensed'; font-size: 13px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  display: flex; align-items: center; gap: 6px;
  min-height: 36px;
}
#pull-btn:active { transform: scale(0.97); }
#pull-btn.loading { opacity: 0.6; pointer-events: none; }
#pull-status {
  font-size: 11px; color: #555; font-weight: 300;
}
#pull-status.live { color: #06d6a0; }
#pull-status.error { color: #e63946; }
#pull-info { flex: 1; text-align: right; margin-left: 10px; }
#pull-helper { font-size: 10px; font-weight: 500; margin-top: 2px; }
#pull-helper:empty { display: none; }
#nav.hidden { display: none; }
.round-badge.hidden { opacity: 0; }

/* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
main {
  flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
  padding: 16px 16px 20px; z-index: 5;
}

/* â”€â”€â”€ NAV â”€â”€â”€ */
nav {
  flex-shrink: 0; display: flex; z-index: 10;
  background: rgba(10,10,10,0.97);
  border-top: 1px solid rgba(255,255,255,0.08);
  padding: 6px 0 max(8px, env(safe-area-inset-bottom));
}
nav button {
  flex: 1; background: transparent; border: none; color: #555;
  padding: 8px 4px; cursor: pointer;
  font-family: 'Barlow Condensed'; font-size: 10px; font-weight: 700;
  letter-spacing: 1.2px; text-transform: uppercase;
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  min-height: 48px; justify-content: center;
  transition: all 0.15s;
}
nav button.active {
  color: #f7c948; background: rgba(247,201,72,0.06);
  border-top: 2px solid #f7c948;
}
nav button .nav-icon { font-size: 18px; }

/* â”€â”€â”€ TYPOGRAPHY HELPERS â”€â”€â”€ */
.bebas { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2.5px; }
.mono { font-family: 'JetBrains Mono', monospace; }
.section-title {
  font-family: 'Bebas Neue', sans-serif; font-size: 22px;
  letter-spacing: 2.5px; margin-bottom: 12px;
}
.section-sub { font-size: 13px; color: #777; font-weight: 300; margin-bottom: 14px; }

/* â”€â”€â”€ CARDS â”€â”€â”€ */
.card {
  background: rgba(255,255,255,0.025); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 12px; margin-bottom: 10px; overflow: hidden;
}
.info-card {
  border-radius: 10px; padding: 14px 16px; margin-bottom: 12px;
}

/* â”€â”€â”€ RIDER ROW â”€â”€â”€ */
.rider-header {
  padding: 14px 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: space-between;
}
.rider-header:active { background: rgba(255,255,255,0.02); }
.rider-rank {
  font-family: 'Bebas Neue', sans-serif; font-size: 22px;
  width: 32px; text-align: center; flex-shrink: 0;
}
.rider-info { margin-left: 12px; flex: 1; min-width: 0; }
.rider-name { font-weight: 700; font-size: 15px; color: #fff; }
.rider-num { font-family: 'JetBrains Mono'; font-size: 11px; color: #555; margin-right: 5px; }
.rider-team { font-size: 12px; font-weight: 300; color: #888; }
.rider-score {
  font-family: 'JetBrains Mono'; font-size: 17px; font-weight: 700;
  text-align: right; margin-right: 10px;
}
.rider-arrow { color: #555; font-size: 12px; transition: transform 0.2s; flex-shrink: 0; }
.rider-arrow.open { transform: rotate(180deg); }
.rider-details {
  padding: 0 16px 16px; border-top: 1px solid rgba(255,255,255,0.05);
}

/* â”€â”€â”€ STAT GRID â”€â”€â”€ */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 12px; }
.stat-box {
  background: rgba(255,255,255,0.04); border-radius: 8px;
  padding: 8px 6px; text-align: center;
}
.stat-label {
  font-size: 9px; letter-spacing: 1.5px; color: #555;
  text-transform: uppercase; font-weight: 700;
}
.stat-value {
  font-family: 'JetBrains Mono'; font-size: 14px;
  font-weight: 700; color: #fff; margin-top: 2px;
}
.stat-sub { font-size: 10px; color: #888; margin-top: 1px; }

/* â”€â”€â”€ RATING BAR â”€â”€â”€ */
.rating-bar { margin-bottom: 6px; }
.rating-bar .bar-label {
  display: flex; justify-content: space-between; margin-bottom: 2px;
}
.rating-bar .bar-label span:first-child {
  font-size: 11px; color: #888; letter-spacing: 1px;
  text-transform: uppercase; font-weight: 600;
}
.rating-bar .bar-label span:last-child {
  font-family: 'JetBrains Mono'; font-size: 11px; font-weight: 700;
}
.bar-track { height: 5px; border-radius: 3px; background: rgba(255,255,255,0.06); }
.bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s ease; }

/* â”€â”€â”€ NOTE BOXES â”€â”€â”€ */
.note-box {
  margin-top: 10px; padding: 10px 12px;
  background: rgba(255,255,255,0.02); border-radius: 8px;
}
.note-box .note-title {
  font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
  text-transform: uppercase; margin-bottom: 4px;
}
.note-box p { font-size: 13px; font-weight: 300; color: #ccc; line-height: 1.6; margin: 0; }

/* â”€â”€â”€ SLIDERS â”€â”€â”€ */
.slider-group { margin-bottom: 14px; }
.slider-group .slider-head {
  display: flex; justify-content: space-between; margin-bottom: 4px;
}
.slider-group .slider-head span:first-child { font-size: 13px; font-weight: 600; color: #ddd; }
.slider-group .slider-head span:last-child {
  font-family: 'JetBrains Mono'; font-size: 13px; color: #06d6a0; font-weight: 700;
}
input[type="range"] {
  width: 100%; height: 8px; cursor: pointer;
  accent-color: #06d6a0; -webkit-appearance: auto;
}

/* â”€â”€â”€ GRADE â”€â”€â”€ */
.pick-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.pick-label {
  font-family: 'Bebas Neue', sans-serif; font-size: 14px;
  min-width: 75px; text-align: right; letter-spacing: 1px;
}
.pick-row select {
  flex: 1; background: rgba(255,255,255,0.05);
  color: #fff; padding: 12px 14px; border-radius: 8px;
  font-family: 'Barlow Condensed'; font-size: 15px; cursor: pointer;
  -webkit-appearance: auto; appearance: auto;
}
.grade-btn {
  width: 100%; padding: 16px; border-radius: 10px; border: none;
  cursor: pointer; font-family: 'Bebas Neue'; font-size: 22px;
  letter-spacing: 3px; transition: all 0.2s; margin-top: 8px;
}
.grade-btn.ready { background: linear-gradient(135deg, #e63946, #ff6b35); color: #fff; }
.grade-btn.ready:active { transform: scale(0.98); }
.grade-btn.disabled { background: #333; color: #666; cursor: not-allowed; }

/* â”€â”€â”€ PREDICTED ORDER ROW â”€â”€â”€ */
.pred-row {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 12px; border-radius: 0 8px 8px 0;
  margin-bottom: 6px;
}
.pred-rank {
  font-family: 'Bebas Neue'; font-size: 20px;
  width: 28px; text-align: center; flex-shrink: 0;
}
.pred-info { flex: 1; min-width: 0; }
.pred-name { font-weight: 700; font-size: 14px; color: #fff; }
.pred-rationale { font-size: 12px; font-weight: 300; color: #888; line-height: 1.4; margin-top: 1px; }
.pred-score {
  font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 700; flex-shrink: 0;
}

/* â”€â”€â”€ GRADE RESULT â”€â”€â”€ */
.grade-result-card {
  text-align: center; padding: 28px 20px;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 14px; margin-bottom: 16px;
}
.grade-emoji { font-size: 52px; margin-bottom: 4px; }
.grade-letter { font-family: 'Bebas Neue'; font-size: 60px; line-height: 1; }
.grade-pts { font-family: 'JetBrains Mono'; font-size: 15px; color: #888; margin-top: 6px; }
.grade-msg { font-size: 15px; font-weight: 400; color: #ccc; margin-top: 10px; line-height: 1.5; }
.grade-detail {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 14px; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06); border-radius: 10px;
  margin-bottom: 6px;
}
.grade-detail-left .gd-pos {
  font-size: 11px; font-weight: 700; color: #888;
  letter-spacing: 1.5px; text-transform: uppercase;
}
.grade-detail-left .gd-name { font-weight: 700; color: #fff; font-size: 15px; margin-top: 2px; }
.grade-detail-left .gd-model {
  font-family: 'JetBrains Mono'; font-size: 11px; color: #555;
}
.grade-detail-right { text-align: right; }
.grade-detail-right .gd-tag { font-size: 13px; margin-bottom: 2px; }
.grade-detail-right .gd-pts { font-family: 'JetBrains Mono'; font-size: 15px; font-weight: 700; }

/* â”€â”€â”€ STANDINGS ROW â”€â”€â”€ */
.standings-pills { display: flex; flex-wrap: wrap; gap: 8px; }
.standings-pill {
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.04); border-radius: 6px;
  padding: 5px 10px;
}
.standings-pill .sp-rank { font-family: 'JetBrains Mono'; font-size: 11px; font-weight: 700; }
.standings-pill .sp-name { font-size: 13px; font-weight: 500; color: #ddd; }
.standings-pill .sp-pts { font-family: 'JetBrains Mono'; font-size: 11px; color: #888; }

/* â”€â”€â”€ ACCESS CODE MODAL â”€â”€â”€ */
#key-modal {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.85); backdrop-filter: blur(6px);
  justify-content: center; align-items: center; padding: 24px;
}
#key-modal.show { display: flex; }
#key-modal .modal-box {
  background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1);
  border-radius: 14px; padding: 28px 24px; max-width: 380px; width: 100%;
}
#key-modal h2 {
  font-family: 'Bebas Neue'; font-size: 24px; color: #f7c948;
  letter-spacing: 2px; margin-bottom: 8px;
}
#key-modal p { font-size: 13px; color: #888; font-weight: 300; line-height: 1.5; margin-bottom: 16px; }
#key-input {
  width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
  color: #fff; padding: 14px; border-radius: 8px;
  font-family: 'JetBrains Mono'; font-size: 12px; margin-bottom: 12px;
}
#key-input::placeholder { color: #555; }
#key-submit {
  width: 100%; padding: 14px; border: none; border-radius: 8px;
  background: linear-gradient(135deg, #f7c948, #ff6b35); color: #000;
  font-family: 'Bebas Neue'; font-size: 18px; letter-spacing: 2px;
  cursor: pointer;
}
#key-submit:active { transform: scale(0.98); }
#key-cancel {
  width: 100%; padding: 10px; border: none; background: transparent;
  color: #666; font-family: 'Barlow Condensed'; font-size: 13px;
  cursor: pointer; margin-top: 6px;
}

/* â”€â”€â”€ LOADING OVERLAY â”€â”€â”€ */
#loading-overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.85); backdrop-filter: blur(6px);
  justify-content: center; align-items: center; flex-direction: column; gap: 16px;
}
#loading-overlay.show { display: flex; }
.spinner {
  width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
  border-top-color: #f7c948; border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
#loading-text {
  font-size: 14px; color: #ccc; font-weight: 400;
  text-align: center; max-width: 280px; line-height: 1.5;
}

/* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
.fade-in { animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

/* â”€â”€â”€ CHAOS BUTTON â”€â”€â”€ */
#chaos-btn {
  width: 100%; padding: 16px; border-radius: 12px;
  background: linear-gradient(135deg, rgba(230,57,70,0.2), rgba(255,107,53,0.15));
  border: 1px solid rgba(255,107,53,0.35);
  color: #ff6b35; cursor: pointer;
  font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 3px;
  margin-top: 20px; transition: all 0.2s;
}
#chaos-btn:active { transform: scale(0.98); }
#chaos-btn.loading { opacity: 0.5; pointer-events: none; }


</style>
</head>
<body>

<div id="app">
  <div id="accent-bar"></div>

  <header>
    <div class="logo">
      <h1>SX ORACLE</h1>
      <p>2026 Supercross Intelligence</p>
    </div>
    <div class="round-badge" id="round-badge">
      <div class="rnum" id="hdr-round">â€”</div>
      <div class="rname" id="hdr-venue">â€”</div>
    </div>
  </header>

  <div id="pull-bar">
    <button id="pull-btn" onclick="handlePull()">ğŸ”„ PULL FRESH INTEL</button>
    <div id="pull-info">
      <div id="pull-status">No data loaded</div>
      <div id="pull-helper"></div>
    </div>
  </div>

  <main id="content"></main>

  <nav id="nav">
    <button class="active" data-tab="briefing" onclick="switchTab('briefing')">
      <span class="nav-icon">ğŸ“Š</span>Briefing
    </button>
    <button data-tab="intel" onclick="switchTab('intel')">
      <span class="nav-icon">âš¡</span>Intel
    </button>
    <button data-tab="model" onclick="switchTab('model')">
      <span class="nav-icon">ğŸ›ï¸</span>Model
    </button>
    <button data-tab="grade" onclick="switchTab('grade')">
      <span class="nav-icon">ğŸ“</span>Grade
    </button>
  </nav>
</div>

<!-- Access Code Modal -->
<div id="key-modal">
  <div class="modal-box">
    <h2>ğŸ”‘ ACCESS CODE</h2>
    <p>Paste the access code from the group chat to unlock live features. The code is saved locally so you won't need to re-enter it.</p>
    <input type="password" id="key-input" placeholder="Paste access code here..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <button id="key-submit" onclick="submitKey()">CONNECT</button>
    <button id="key-cancel" onclick="closeKeyModal()">Cancel</button>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text">Searching for live data...</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentTab = 'briefing';
let apiKey = null;
let expandedRider = null;
let picks = [null, null, null, null, null];
let gradeResult = null;
let keyCallback = null; // function to call after access code is submitted
let cacheTimestamp = null; // when data was last pulled
let hasLiveData = false; // true after first successful pull or cache load

const ROUNDS = [
  { num: 1,  name: 'Anaheim 1',      short: 'A1',  city: 'Anaheim, CA',       date: '2026-01-04' },
  { num: 2,  name: 'San Diego',       short: 'SD',  city: 'San Diego, CA',     date: '2026-01-11' },
  { num: 3,  name: 'Anaheim 2',       short: 'A2',  city: 'Anaheim, CA',       date: '2026-01-18' },
  { num: 4,  name: 'Houston',         short: 'HOU', city: 'Houston, TX',       date: '2026-01-25' },
  { num: 5,  name: 'Glendale',        short: 'GLE', city: 'Glendale, AZ',      date: '2026-02-07' },
  { num: 6,  name: 'Seattle',         short: 'SEA', city: 'Seattle, WA',       date: '2026-02-14' },
  { num: 7,  name: 'Arlington',       short: 'ARL', city: 'Arlington, TX',     date: '2026-02-21' },
  { num: 8,  name: 'Tampa',           short: 'TMP', city: 'Tampa, FL',         date: '2026-02-28' },
  { num: 9,  name: 'Daytona',         short: 'DAY', city: 'Daytona Beach, FL', date: '2026-03-07' },
  { num: 10, name: 'Indianapolis',    short: 'IND', city: 'Indianapolis, IN',  date: '2026-03-14' },
  { num: 11, name: 'Birmingham',      short: 'BHM', city: 'Birmingham, AL',    date: '2026-03-21' },
  { num: 12, name: 'Detroit',         short: 'DET', city: 'Detroit, MI',       date: '2026-03-28' },
  { num: 13, name: 'Foxborough',      short: 'FOX', city: 'Foxborough, MA',    date: '2026-04-11' },
  { num: 14, name: 'Nashville',       short: 'NSH', city: 'Nashville, TN',     date: '2026-04-18' },
  { num: 15, name: 'St. Louis',       short: 'STL', city: 'St. Louis, MO',     date: '2026-04-25' },
  { num: 16, name: 'Denver',          short: 'DEN', city: 'Denver, CO',        date: '2026-05-02' },
  { num: 17, name: 'Salt Lake City',  short: 'SLC', city: 'Salt Lake City, UT',date: '2026-05-09' }
];

const DEFAULT_WEIGHTS = {
  qualifying: 25, recentForm: 20, trackHistory: 15,
  starts: 15, trackFit: 10, health: 10, pressure: 5
};
let weights = { ...DEFAULT_WEIGHTS };

const WEIGHT_META = {
  qualifying:   { label: 'Qualifying Speed',     icon: 'â±ï¸' },
  recentForm:   { label: 'Recent Form',          icon: 'ğŸ“ˆ' },
  trackHistory: { label: 'Track History',         icon: 'ğŸŸï¸' },
  starts:       { label: 'Start / Holeshot',      icon: 'ğŸš€' },
  trackFit:     { label: 'Track Fit (Hard-Pack)',  icon: 'ğŸœï¸' },
  health:       { label: 'Health Status',          icon: 'ğŸ’ª' },
  pressure:     { label: 'Championship Pressure',  icon: 'ğŸ§ ' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ EVENT DATA (Baked-in: R5 Glendale) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let eventData = {
  round: 5, name: 'GLENDALE', venue: 'State Farm Stadium', city: 'Glendale, AZ',
  date: '2026-02-07', format: 'Standard Main Event',
  surface: 'Hard-pack / Dry / Enclosed Dome',
  trackNotes: 'Largest stadium floor of the year. Hard-pack surface dries out through the night â€” favors riders comfortable on slick, aggressive dirt. Long start straight incorporated into the racing lap. Multiple long rhythm lane options. Sweeping right-hand sand section with viable inside/outside. Unique 180Â° left-hander built from deep, soft mulch that breaks down unpredictably late in the race.',
  theCall: '<strong>Tomac is the pick tonight.</strong> Second-fastest qualifier â€” nine thousandths off Prado â€” and he\'s never finished worse than 4th at this building in his career. He lives in Arizona. This is a home race. <strong>Roczen</strong> is the biggest threat: three wins, six podiums, 2.75 career average at Glendale. Those numbers are absurd. <strong>Hunter Lawrence</strong> rounds out the podium â€” best starts in the series and four straight top-3s, but he\'s never won a 450 main event. <strong>Prado</strong> is the wildcard â€” fastest qualifier and an elite starter. If he holeshots, all bets are off.',
  injuriesOut: [
    { rider: 'Jett Lawrence', detail: 'Fractured talus & navicular (R foot) â€” out for SX season' },
    { rider: 'Austin Forkner', detail: 'Fractured left hand â€” in cast, week-to-week' },
    { rider: 'RJ Hampshire', detail: 'Illness â€” pulled out during qualifying today' },
    { rider: 'Cade Clason', detail: 'Broken collarbone (Houston) â€” no timetable' },
    { rider: 'Chance Hymas', detail: 'Dislocated shoulder â€” surgery required' }
  ],
  injuriesHurt: [
    { rider: 'Joey Savatgy', detail: 'Broken toe (Houston) â€” racing through it' },
    { rider: 'Justin Barcia', detail: 'Battling nagging issues â€” limited results' }
  ],
  standings: [
    { name: 'Eli Tomac', pts: 88 },
    { name: 'Hunter Lawrence', pts: 84 },
    { name: 'Ken Roczen', pts: 76 },
    { name: 'Chase Sexton', pts: 74 },
    { name: 'Cooper Webb', pts: 71 },
    { name: 'Jason Anderson', pts: 62 }
  ],
  standingsNote: 'Jett Lawrence (fractured foot) out for the foreseeable future.'
};

let ridersData = [
  {
    id:1, name:'Eli Tomac', num:3, team:'Red Bull KTM',
    qRank:2, qTime:'56.460', qGap:'+0.009s',
    results:[1,1,3,4], pts:88,
    gHist:9.5, start:6.0, tFit:9.5, health:10, form:8.5,
    historyText:'All-time Phoenix/Glendale wins leader (5). Never worse than 4th at State Farm Stadium. Won 2022 & 2023 Glendale Triple Crowns. First-ever 450 win came in Phoenix in 2015.',
    notes:'Points leader, Arizona-based â€” considers Glendale a home race. Just 0.009s off Prado\'s fastest qualifying time. Uncorked a huge quad line before the mechanics area in Q2 nobody else was hitting. Hard-pack surface has always suited his style. The question isn\'t whether Tomac will be fast â€” it\'s whether he gets a start clean enough to avoid traffic.',
    rationale:'Complete package â€” elite qualifier, best venue history, points leader.'
  },
  {
    id:2, name:'Ken Roczen', num:94, team:'ECSTAR Suzuki',
    qRank:3, qTime:'~56.7', qGap:'+0.3s',
    results:[2,3,5,3], pts:76,
    gHist:10, start:8.5, tFit:9.5, health:10, form:7.5,
    historyText:'The Glendale King. 3 wins, 6 podiums in 8 starts. Career 2.75 avg finish â€” best in the field. 2025: 4-1-5 for 3rd overall.',
    notes:'His numbers at this building are staggering. Thrives on hard-pack. P3 qualifier, only three-tenths off. If Roczen gets to the first turn in the top 3, history says he holds it. Don\'t be surprised if he wins outright.',
    rationale:'2.75 career avg at Glendale. If he starts top 3, good luck passing him.'
  },
  {
    id:3, name:'Hunter Lawrence', num:96, team:'Honda HRC',
    qRank:4, qTime:'~56.8', qGap:'+0.4s',
    results:[3,2,2,2], pts:84,
    gHist:6.0, start:9.5, tFit:8.0, health:10, form:9.0,
    historyText:'No 450SX win anywhere. 5th at 2025 Glendale TC (5-9-4). But 2026 form is historically consistent â€” 4 straight top-3 finishes.',
    notes:'Three-time runner-up in 2026. Best avg first-lap position in the series (2.4) â€” massive advantage on hard-pack where passing is limited. 4 points off the red plate. The question is whether tonight is finally the breakthrough.',
    rationale:'Most consistent rider + best starter. Due for a breakthrough but Glendale history lags.'
  },
  {
    id:4, name:'Chase Sexton', num:4, team:'Kawasaki',
    qRank:5, qTime:'~56.9', qGap:'+0.5s',
    results:[5,5,1,5], pts:74,
    gHist:8.5, start:6.5, tFit:7.5, health:10, form:6.0,
    historyText:'Defending Glendale winner (2025 TC: 3-3-2). Won 2023 Glendale TC. Won 2024 standard format. Podiumed last 3 visits. 2023 SX champion.',
    notes:'The defending Glendale winner has the talent to win any race â€” we saw it at A2. But 2026 consistency is the issue: three 5ths sandwiching that win. P5 qualifier, half a second off. Venue form keeps him top 5 but not the pick tonight.',
    rationale:'Defending Glendale winner, but 2026 inconsistency (three 5ths) knocks him down.'
  },
  {
    id:5, name:'Cooper Webb', num:1, team:'Star Yamaha',
    qRank:6, qTime:'~57.2', qGap:'+0.7s',
    results:[5,7,6,1], pts:71,
    gHist:7.5, start:7.5, tFit:8.0, health:10, form:6.5,
    historyText:'2nd at 2025 Glendale TC (1-5-3, won Race 1). Defending 450SX champion. Averages 2.16 finish after first win of season historically.',
    notes:'Won Houston without winning a single TC race â€” peak Webb. He doesn\'t need to be fastest, just smartest. Post-first-win surge is real (2.16 avg). BUT P6 qualifying is 0.7s off â€” a meaningful speed gap. Top 5 certainty, win requires mistakes ahead of him.',
    rationale:'Post-first-win momentum is real, but 0.7s qualifying gap says top 5 not win.'
  },
  {
    id:6, name:'Jorge Prado', num:26, team:'Red Bull KTM',
    qRank:1, qTime:'56.451', qGap:'FASTEST',
    results:[9,8,7,7], pts:56,
    gHist:3.0, start:10, tFit:7.0, health:10, form:4.0,
    historyText:'Only 2nd SX season. Two-time MXGP World Champion (2023-24). Elite talent adapting to stadium format. Improving trend: 9â†’8â†’7â†’7.',
    notes:'THE FASTEST QUALIFIER. His 56.451 beat everyone. Holeshot ability from MXGP is world-class. On this big floor with a long start straight, if Prado holeshots, can anyone pass him? Season results (9-8-7-7) show clear improvement. The counter: 20 minutes of SX main event is different than a hot lap. Ceiling of 1st, floor of 8th.',
    rationale:'Fastest qualifier + elite starter = volatile. Ceiling of a win, floor of 8th.'
  },
  {
    id:7, name:'Jason Anderson', num:21, team:'ECSTAR Suzuki',
    qRank:7, qTime:'~57.3', qGap:'+0.8s',
    results:[4,4,4,6], pts:62,
    gHist:7.0, start:6.0, tFit:8.0, health:10, form:7.5,
    historyText:'Solid Glendale history, track suits his style. Three consecutive 4th-place finishes to open the season.',
    notes:'Most underrated rider in the paddock. Three straight 4ths â€” nobody talks about him because he\'s not winning. Hard-pack suits his style. P7 qualifier but Anderson races better than he qualifies. Smart money for top 5.',
    rationale:'Mr. Consistent â€” three straight 4ths. Hard-pack suits him. Safe, smart top-5 pick.'
  },
  {
    id:8, name:'Aaron Plessinger', num:7, team:'Red Bull KTM',
    qRank:3, qTime:'~56.7', qGap:'+0.3s',
    results:[10,6,9,7], pts:36,
    gHist:5.0, start:5.0, tFit:7.0, health:10, form:4.5,
    historyText:'9th at 2025 Glendale TC (10-7-9). Not a venue where he\'s historically excelled. Strong KTM machinery.',
    notes:'The surprise of qualifying â€” P3, only 0.3s off P1. If you weight qualifying heavily, Plessinger jumps way up. Problem: race results don\'t match practice speed. Big floor could suit him. A swing pick â€” podium or 9th.',
    rationale:'P3 qualifier is eye-catching, but race-day execution has been the issue all season.'
  },
  {
    id:9, name:'Justin Cooper', num:32, team:'Star Yamaha',
    qRank:8, qTime:'~57.5', qGap:'+1.0s',
    results:[6,9,3,7], pts:57,
    gHist:5.0, start:6.0, tFit:6.5, health:10, form:5.5,
    historyText:'Growing on the 450. Flashed podium speed at A2 (3rd). Improving weekly per MXA reports.',
    notes:'The A2 podium was real but so is the inconsistency (6th, 9th, 7th). Trajectory is up but gap to the top 5 is real. 6th-8th feels right. Needs chaos ahead to podium.',
    rationale:'Improving trajectory, but 1-second qualifying gap and inconsistency say 6th-8th.'
  },
  {
    id:10, name:'Joey Savatgy', num:17, team:'Honda HRC',
    qRank:9, qTime:'~57.6', qGap:'+1.1s',
    results:[7,11,10,9], pts:50,
    gHist:5.0, start:6.0, tFit:6.0, health:5.0, form:4.0,
    historyText:'Consistent top-10 career. Not a Glendale podium threat historically.',
    notes:'Broken toe from Houston is the story. He\'s lining up which shows toughness, but a broken toe on hard-pack is brutal â€” every bump through the peg. Expect him to fade in the final 5 minutes.',
    rationale:'Broken toe on hard-pack = limited. Gutsy to race but expect late-race fade.'
  },
  {
    id:11, name:'Dylan Ferrandis', num:14, team:'Ducati',
    qRank:10, qTime:'~57.8', qGap:'+1.3s',
    results:[8,10,8,10], pts:49,
    gHist:4.5, start:5.0, tFit:5.5, health:10, form:4.0,
    historyText:'Ducati\'s debut SX season. Mid-pack results. New platform being developed in real time.',
    notes:'The Ducati development project. Consistent but consistently 8th-10th. Not a podium factor. Safe pick if you need a 9th-10th place guess.',
    rationale:'Ducati development year. Consistently 8th-10th but no upside beyond that.'
  },
  {
    id:12, name:'Malcolm Stewart', num:27, team:'Husqvarna',
    qRank:12, qTime:'~58.2', qGap:'+1.7s',
    results:[12,12,11,8], pts:36,
    gHist:5.0, start:7.0, tFit:6.0, health:10, form:3.5,
    historyText:'125th career 450SX start. Strong starter. Inconsistent Glendale history. Best 2026 result: 8th in Houston.',
    notes:'Showed life in Houston with an 8th. Strong starter, always gives him a shot. But P12 qualifying and poor season form limit his ceiling. Probably 8th-12th.',
    rationale:'Flashed in Houston but P12 qualifying and poor form limit ceiling.'
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ SCORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scoreRiders(riders, w) {
  const tot = Object.values(w).reduce((a, b) => a + b, 0) || 1;
  return riders.map(r => {
    const qScore = Math.max(1, 10 - (r.qRank - 1) * 0.75);
    const pScore = r.pts > 80 ? 6 : r.pts > 60 ? 7.5 : 8.5;
    const s = (
      qScore * w.qualifying +
      r.form * w.recentForm +
      r.gHist * w.trackHistory +
      r.start * w.starts +
      r.tFit * w.trackFit +
      r.health * w.health +
      pScore * w.pressure
    ) / tot;
    return { ...r, score: Math.round(s * 10) / 10 };
  }).sort((a, b) => b.score - a.score);
}

function gradeLineup(userPicks, ranked) {
  const top8ids = ranked.slice(0, 8).map(r => r.id);
  let total = 0;
  const details = userPicks.map((pid, idx) => {
    if (!pid) return null;
    const mIdx = ranked.findIndex(r => r.id === pid);
    const rider = ranked.find(r => r.id === pid);
    if (!rider || mIdx < 0) return null;
    const diff = Math.abs(mIdx - idx);
    let pts, tag, suggestion = null;
    if (diff === 0)      { pts = 20; tag = 'ğŸ¯ Perfect match'; }
    else if (diff <= 1)  { pts = 16; tag = 'âœ… Great pick'; }
    else if (diff <= 2)  { pts = 12; tag = 'ğŸ‘ Solid pick'; }
    else if (top8ids.includes(pid)) { pts = 8; tag = 'ğŸ¤” Viable reach'; }
    else                 { pts = 3;  tag = 'âš ï¸ Bold swing'; }

    // Generate per-pick suggestion when not perfect
    if (diff > 0) {
      const modelPick = ranked[idx];
      if (diff <= 2) {
        suggestion = `The model has ${rider.name} at #${mIdx+1}. Close call â€” ${diff === 1 ? 'just one spot off' : 'two spots off'}.`;
      } else if (top8ids.includes(pid)) {
        suggestion = `The model has ${rider.name} at #${mIdx+1}, not #${idx+1}. For this slot, the model prefers ${modelPick.name} (${modelPick.rationale.toLowerCase()})`;
      } else {
        suggestion = `${rider.name} is #${mIdx+1} in the model â€” a big gap from your #${idx+1} slot. The model would pick ${modelPick.name} here (${modelPick.rationale.toLowerCase()})`;
      }
    }

    total += pts;
    return { pos: idx + 1, rider: rider.name, modelRank: mIdx + 1, pts, tag, suggestion };
  }).filter(Boolean);

  const pct = Math.round(total / 100 * 100);
  let grade, emoji, msg;
  if (pct >= 85)      { grade = 'A+'; emoji = 'ğŸ†'; msg = 'Your picks are dialed. The model loves this lineup.'; }
  else if (pct >= 70) { grade = 'A';  emoji = 'ğŸ”¥'; msg = 'Strong lineup â€” the model sees a lot to like here.'; }
  else if (pct >= 55) { grade = 'B';  emoji = 'ğŸ‘Š'; msg = 'Solid foundation with some bold calls mixed in.'; }
  else if (pct >= 40) { grade = 'C';  emoji = 'ğŸ²'; msg = 'Swinging for the fences. High risk, high reward.'; }
  else                { grade = 'D';  emoji = 'ğŸ’€'; msg = 'Going full rogue. The model doesn\'t see it â€” but upsets happen.'; }

  // Overall suggestion
  let suggestion = null;
  const modelTop5 = ranked.slice(0, 5);
  const userRiderIds = userPicks.filter(Boolean);
  const missingFromModel = modelTop5.filter(r => !userRiderIds.includes(r.id));
  if (missingFromModel.length > 0 && pct < 85) {
    const names = missingFromModel.map(r => r.name);
    if (names.length === 1) {
      suggestion = `You're missing ${names[0]} from the model's top 5. ${missingFromModel[0].rationale}`;
    } else {
      suggestion = `The model's top 5 includes ${names.slice(0, -1).join(', ')} and ${names[names.length-1]} â€” you're leaving ${names.length === 2 ? 'both' : 'them'} out. That's a big bet against the data. It might pay off, but know what you're fading.`;
    }
  }

  return { total, pct, grade, emoji, msg, details, suggestion };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function accentColor(i) {
  if (i === 0) return '#f7c948';
  if (i === 1) return '#c0c0c0';
  if (i === 2) return '#cd7f32';
  return '#555';
}
function medal(i) {
  if (i === 0) return 'ğŸ¥‡';
  if (i === 1) return 'ğŸ¥ˆ';
  if (i === 2) return 'ğŸ¥‰';
  return i + 1;
}

let shouldScrollTop = false;

function render() {
  const content = document.getElementById('content');
  const nav = document.getElementById('nav');
  const badge = document.getElementById('round-badge');

  // Update helper text
  updateHelperText();

  // Welcome screen when no live data
  if (!hasLiveData) {
    nav.classList.add('hidden');
    badge.classList.add('hidden');
    content.innerHTML = renderWelcome();
    return;
  }

  nav.classList.remove('hidden');
  badge.classList.remove('hidden');
  const ranked = scoreRiders(ridersData, currentTab === 'model' ? weights : DEFAULT_WEIGHTS);

  if (currentTab === 'briefing') content.innerHTML = renderBriefing(ranked);
  else if (currentTab === 'intel') content.innerHTML = renderIntel(ranked);
  else if (currentTab === 'model') content.innerHTML = renderModel(ranked);
  else if (currentTab === 'grade') content.innerHTML = renderGrade(ranked);

  if (shouldScrollTop) {
    content.scrollTop = 0;
    shouldScrollTop = false;
  }
}

function renderWelcome() {
  const nextRound = getNextRound();
  const nextInfo = nextRound
    ? `R${nextRound.num} ${nextRound.name} Â· ${nextRound.city} Â· ${formatDate(nextRound.date)}`
    : '2026 Monster Energy Supercross';

  return `
    <div class="fade-in" style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 24px;min-height:60vh">
      <div style="font-size:56px;margin-bottom:16px">ğŸ</div>
      <div class="bebas" style="font-size:36px;letter-spacing:4px;color:#f7c948;margin-bottom:4px">SX ORACLE</div>
      <div style="font-size:13px;color:#888;font-weight:300;margin-bottom:32px">${nextInfo}</div>
      <div style="max-width:280px;margin-bottom:32px">
        <p style="font-size:14px;color:#aaa;font-weight:300;line-height:1.7;margin-bottom:12px">
          AI-powered Supercross intelligence for your fantasy lineup. Predictions, rider intel, and pick grading â€” all from one pull.
        </p>
        <p style="font-size:13px;color:#666;font-weight:300;line-height:1.6">
          Tap <strong style="color:#f7c948">Pull Fresh Intel</strong> above to connect and load live data.
        </p>
      </div>
      <div style="display:flex;gap:24px;justify-content:center;flex-wrap:wrap">
        <div style="text-align:center">
          <div style="font-size:24px;margin-bottom:4px">ğŸ“Š</div>
          <div style="font-size:10px;color:#555;font-weight:600;letter-spacing:1px">BRIEFING</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:24px;margin-bottom:4px">âš¡</div>
          <div style="font-size:10px;color:#555;font-weight:600;letter-spacing:1px">INTEL</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:24px;margin-bottom:4px">ğŸ›ï¸</div>
          <div style="font-size:10px;color:#555;font-weight:600;letter-spacing:1px">MODEL</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:24px;margin-bottom:4px">ğŸ“</div>
          <div style="font-size:10px;color:#555;font-weight:600;letter-spacing:1px">GRADE</div>
        </div>
      </div>
    </div>`;
}

function renderBriefing(ranked) {
  const e = eventData;
  let html = '<div class="fade-in">';

  // Event header
  html += `
    <div style="text-align:center;margin-bottom:20px">
      <div class="mono" style="font-size:11px;color:#e63946;margin-bottom:2px">ROUND ${e.round} â€” ${e.format.toUpperCase()}</div>
      <div class="bebas" style="font-size:34px;letter-spacing:4px;color:#fff">${e.name}</div>
      <div style="font-size:13px;font-weight:300;color:#888;margin-top:2px">${e.venue} Â· ${e.city}</div>
      <div style="font-size:12px;color:#555;margin-top:2px">${e.surface}</div>
    </div>`;

  // The Call
  html += `
    <div style="background:linear-gradient(135deg,rgba(247,201,72,0.12),transparent);border:1px solid rgba(247,201,72,0.3);border-radius:12px;padding:18px 16px;margin-bottom:16px">
      <div class="bebas" style="font-size:16px;color:#f7c948;margin-bottom:8px">ğŸ¯ THE CALL</div>
      <p style="font-size:15px;font-weight:400;color:#eee;line-height:1.65">${e.theCall}</p>
    </div>`;

  // Track Intel
  html += `
    <div class="info-card" style="background:rgba(17,138,178,0.08);border:1px solid rgba(17,138,178,0.25)">
      <div style="font-weight:700;color:#118ab2;font-size:13px;letter-spacing:1px;margin-bottom:6px">ğŸŸï¸ TRACK INTEL</div>
      <p style="font-size:13px;font-weight:300;color:#ccc;line-height:1.6">${e.trackNotes}</p>
    </div>`;

  // Injury Report
  html += `
    <div class="info-card" style="background:rgba(230,57,70,0.08);border:1px solid rgba(230,57,70,0.25)">
      <div style="font-weight:700;color:#e63946;font-size:13px;letter-spacing:1px;margin-bottom:6px">ğŸš‘ INJURY REPORT</div>
      <div style="font-size:11px;font-weight:700;color:#e63946;letter-spacing:1.5px;margin-bottom:4px">OUT</div>`;
  e.injuriesOut.forEach(inj => {
    html += `<div style="margin-bottom:3px;font-size:13px;font-weight:300;color:#ccc"><strong style="color:#fff">${inj.rider}</strong> <span style="color:#888">â€” ${inj.detail}</span></div>`;
  });
  html += `<div style="font-weight:700;color:#ff6b35;font-size:11px;letter-spacing:1.5px;margin:10px 0 4px">RACING HURT</div>`;
  e.injuriesHurt.forEach(inj => {
    html += `<div style="margin-bottom:3px;font-size:13px;font-weight:300;color:#ccc"><strong style="color:#fff">${inj.rider}</strong> <span style="color:#888">â€” ${inj.detail}</span></div>`;
  });
  html += `</div>`;

  // Standings
  html += `
    <div class="info-card" style="background:rgba(247,201,72,0.06);border:1px solid rgba(247,201,72,0.2)">
      <div style="font-weight:700;color:#f7c948;font-size:13px;letter-spacing:1px;margin-bottom:8px">ğŸ† CHAMPIONSHIP PICTURE</div>
      <div class="standings-pills">`;
  e.standings.forEach((s, i) => {
    const c = i === 0 ? '#f7c948' : i === 1 ? '#c0c0c0' : '#fff';
    html += `<div class="standings-pill"><span class="sp-rank" style="color:${c}">${i+1}.</span><span class="sp-name">${s.name}</span><span class="sp-pts">${s.pts}</span></div>`;
  });
  html += `</div><div style="font-size:12px;color:#888;margin-top:8px;font-style:italic">${e.standingsNote}</div></div>`;

  // Predicted Order
  html += `<div style="margin-top:20px"><h3 class="section-title" style="color:#fff">PREDICTED FINISHING ORDER</h3>`;
  ranked.forEach((r, i) => {
    const c = accentColor(i);
    const bg = i < 3 ? c + '0D' : 'rgba(255,255,255,0.02)';
    html += `
      <div class="pred-row" style="border-left:3px solid ${c};background:${bg}">
        <div class="pred-rank" style="color:${c}">${medal(i)}</div>
        <div class="pred-info">
          <div class="pred-name"><span class="mono" style="font-size:10px;color:#555;margin-right:4px">#${r.num}</span>${r.name}</div>
          <div class="pred-rationale">${r.rationale}</div>
        </div>
        <div class="pred-score" style="color:${c}">${r.score}</div>
      </div>`;
  });
  html += '</div>';

  // Chaos Factor â€” locked
  html += `
    <div style="margin-top:24px">
      <button id="chaos-btn" style="opacity:0.5;cursor:not-allowed;position:relative" disabled>
        ğŸŒªï¸ SPIN THE CHAOS
        <span style="position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#f7c948,#ff6b35);color:#000;font-size:9px;font-weight:800;padding:3px 8px;border-radius:10px;letter-spacing:1px;font-family:'Barlow Condensed'">PREMIUM</span>
      </button>
      <div style="text-align:center;margin-top:8px;font-size:12px;color:#555">AI-powered what-if scenarios â€” <span style="color:#f7c948">coming soon</span></div>
    </div>`;

  html += '</div>';
  return html;
}

function renderIntel(ranked) {
  let html = '<div class="fade-in">';
  html += '<h3 class="section-title">RIDER INTEL</h3>';
  html += '<p class="section-sub">Tap any rider for qualifying data, season stats, Glendale history, and analyst notes.</p>';

  ranked.forEach((r, i) => {
    const c = accentColor(i);
    const isOpen = expandedRider === r.id;
    const avg = (r.results.reduce((a,b) => a+b, 0) / r.results.length).toFixed(1);
    const qScore = Math.max(1, 10 - (r.qRank - 1) * 0.75);

    html += `<div class="card" style="border-left:3px solid ${c}">`;
    html += `<div class="rider-header" onclick="toggleRider(${r.id})">
      <div style="display:flex;align-items:center">
        <div class="rider-rank" style="color:${c}">${medal(i)}</div>
        <div class="rider-info">
          <div class="rider-name"><span class="rider-num">#${r.num}</span>${r.name}</div>
          <div class="rider-team">${r.team}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="rider-score" style="color:${c}">${r.score}</div>
        <div class="rider-arrow ${isOpen ? 'open' : ''}">â–¼</div>
      </div>
    </div>`;

    if (isOpen) {
      html += `<div class="rider-details">
        <div class="stat-grid">
          <div class="stat-box"><div class="stat-label">QUALI</div><div class="stat-value">P${r.qRank}</div><div class="stat-sub">${r.qGap}</div></div>
          <div class="stat-box"><div class="stat-label">AVG FIN.</div><div class="stat-value">${avg}</div><div class="stat-sub">${r.pts} pts</div></div>
          <div class="stat-box"><div class="stat-label">RESULTS</div><div class="stat-value" style="font-size:12px">${r.results.join('-')}</div><div class="stat-sub">${ROUNDS.slice(0, r.results.length).map(rd => rd.short).join('-')}</div></div>
        </div>
        <div style="margin-top:12px">
          ${ratingBarHTML('Qualifying', qScore, '#f7c948')}
          ${ratingBarHTML('Recent Form', r.form, '#06d6a0')}
          ${ratingBarHTML('Glendale History', r.gHist, '#118ab2')}
          ${ratingBarHTML('Start Ability', r.start, '#ff6b35')}
          ${ratingBarHTML('Track Fit', r.tFit, '#e63946')}
          ${ratingBarHTML('Health', r.health, r.health < 8 ? '#e63946' : '#06d6a0')}
        </div>
        <div class="note-box" style="border-left:2px solid rgba(247,201,72,0.3)">
          <div class="note-title" style="color:#f7c948">GLENDALE HISTORY</div>
          <p>${r.historyText}</p>
        </div>
        <div class="note-box" style="border-left:2px solid rgba(17,138,178,0.3)">
          <div class="note-title" style="color:#118ab2">ANALYST TAKE</div>
          <p>${r.notes}</p>
        </div>
      </div>`;
    }
    html += '</div>';
  });

  html += '</div>';
  return html;
}

function ratingBarHTML(label, val, color) {
  const v = Math.round(val * 10) / 10;
  const pct = (v / 10) * 100;
  return `
    <div class="rating-bar">
      <div class="bar-label"><span>${label}</span><span style="color:${color}">${v}</span></div>
      <div class="bar-track"><div class="bar-fill" style="background:${color};width:${pct}%"></div></div>
    </div>`;
}

function renderModel(ranked) {
  const tot = Object.values(weights).reduce((a,b) => a+b, 0) || 1;
  let html = '<div class="fade-in">';
  html += '<h3 class="section-title" style="color:#06d6a0">CUSTOM MODEL</h3>';
  html += '<p class="section-sub">Adjust weights based on your instincts. Think starts matter more at Glendale? Crank it up and watch the rankings shift.</p>';

  html += `<div style="background:rgba(6,214,160,0.06);border:1px solid rgba(6,214,160,0.15);border-radius:12px;padding:18px 16px;margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="bebas" style="font-size:16px;color:#06d6a0">VARIABLE WEIGHTS</div>
      <button onclick="resetWeights()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:#888;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:11px;font-family:'Barlow Condensed';letter-spacing:1px;font-weight:600;text-transform:uppercase">Reset</button>
    </div>`;

  Object.keys(weights).forEach(k => {
    const m = WEIGHT_META[k];
    const pct = Math.round(weights[k] / tot * 100);
    html += `
      <div class="slider-group">
        <div class="slider-head"><span>${m.icon} ${m.label}</span><span id="wpct-${k}">${pct}%</span></div>
        <input type="range" min="0" max="50" value="${weights[k]}" id="wslider-${k}" oninput="updateWeight('${k}', this.value)">
      </div>`;
  });
  html += '</div>';

  html += '<h3 class="bebas" style="font-size:18px;letter-spacing:2px;margin-bottom:10px">YOUR MODEL\'S RANKINGS</h3>';
  html += '<div id="model-rankings">';
  html += renderModelRankings(ranked);
  html += '</div>';

  html += '</div>';
  return html;
}

function renderModelRankings(ranked) {
  let html = '';
  ranked.forEach((r, i) => {
    const c = accentColor(i);
    html += `
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-left:3px solid ${c};background:rgba(255,255,255,0.02);border-radius:0 8px 8px 0;margin-bottom:5px">
        <div class="bebas" style="font-size:18px;color:${c};min-width:24px;text-align:center">${i+1}</div>
        <div style="flex:1"><span style="font-weight:700;font-size:13px;color:#fff">${r.name}</span> <span style="font-size:11px;color:#666">${r.team}</span></div>
        <div class="mono" style="font-size:14px;font-weight:700;color:${c}">${r.score}</div>
      </div>`;
  });
  return html;
}

function renderGrade(ranked) {
  const labels = ['1st Place', '2nd Place', '3rd Place', '4th Place', '5th Place'];
  const colors = ['#f7c948', '#c0c0c0', '#cd7f32', '#118ab2', '#06d6a0'];
  const filled = picks.filter(p => p !== null).length;
  // Show all 12 riders in dropdowns, sorted by race number for easy scanning
  const allRiders = [...ridersData].sort((a, b) => a.num - b.num);

  let html = '<div class="fade-in">';
  html += '<h3 class="section-title" style="color:#e63946">GRADE MY PICKS</h3>';
  html += '<p class="section-sub">Enter your RM Fantasy top 5 and see how the model scores your lineup.</p>';

  labels.forEach((label, i) => {
    html += `<div class="pick-row">
      <div class="pick-label" style="color:${colors[i]}">${label}</div>
      <select style="border:1px solid ${colors[i]}44" onchange="updatePick(${i}, this.value)">
        <option value="" ${picks[i] === null ? 'selected' : ''}>Select rider...</option>`;
    allRiders.forEach(r => {
      const dis = picks.includes(r.id) && picks[i] !== r.id ? 'disabled' : '';
      const sel = picks[i] === r.id ? 'selected' : '';
      html += `<option value="${r.id}" ${dis} ${sel} style="background:#1a1a2e">#${r.num} ${r.name}</option>`;
    });
    html += `</select></div>`;
  });

  html += `<button class="grade-btn ${filled >= 5 ? 'ready' : 'disabled'}" onclick="${filled >= 5 ? 'doGrade()' : ''}">${filled < 5 ? 'SELECT ' + (5 - filled) + ' MORE RIDER' + (5 - filled > 1 ? 'S' : '') : 'GRADE MY LINEUP'}</button>`;

  if (gradeResult) {
    const g = gradeResult;
    const gc = g.pct >= 70 ? '#06d6a0' : g.pct >= 40 ? '#f7c948' : '#e63946';
    html += `
      <div style="margin-top:24px">
        <div class="grade-result-card">
          <div class="grade-emoji">${g.emoji}</div>
          <div class="grade-letter" style="color:${gc}">${g.grade}</div>
          <div class="grade-pts">${g.total} / 100 pts (${g.pct}%)</div>
          <p class="grade-msg">${g.msg}</p>
        </div>`;
    g.details.forEach((d, i) => {
      const dc = d.pts >= 16 ? '#06d6a0' : d.pts >= 8 ? '#f7c948' : '#e63946';
      html += `
        <div class="grade-detail" style="border-left:3px solid ${dc}">
          <div class="grade-detail-left">
            <div class="gd-pos">Pick #${d.pos}</div>
            <div class="gd-name">${d.rider}</div>
            <div class="gd-model">Model rank: #${d.modelRank}</div>
          </div>
          <div class="grade-detail-right">
            <div class="gd-tag">${d.tag}</div>
            <div class="gd-pts" style="color:${dc}">+${d.pts}</div>
          </div>
        </div>`;
      // Add suggestion if pick scored less than perfect
      if (d.suggestion) {
        html += `<div style="padding:4px 14px 10px;font-size:12px;font-weight:300;color:#888;line-height:1.5;font-style:italic">${d.suggestion}</div>`;
      }
    });

    // Overall suggestion
    if (g.suggestion) {
      html += `
        <div style="margin-top:14px;padding:14px 16px;background:rgba(247,201,72,0.06);border:1px solid rgba(247,201,72,0.15);border-radius:10px">
          <div style="font-weight:700;color:#f7c948;font-size:12px;letter-spacing:1.5px;margin-bottom:6px">ğŸ’¡ MODEL'S TAKE</div>
          <p style="font-size:13px;font-weight:300;color:#ccc;line-height:1.6;margin:0">${g.suggestion}</p>
        </div>`;
    }

    html += '</div>';
  }

  html += '</div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ INTERACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  currentTab = tab;
  expandedRider = null;
  shouldScrollTop = true;
  document.querySelectorAll('#nav button').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === tab);
  });
  render();
}

function toggleRider(id) {
  expandedRider = expandedRider === id ? null : id;
  render();
}

function updateWeight(key, val) {
  weights[key] = Number(val);
  // Targeted update: only change percentage labels and rankings, don't touch sliders
  const tot = Object.values(weights).reduce((a,b) => a+b, 0) || 1;
  Object.keys(weights).forEach(k => {
    const el = document.getElementById('wpct-' + k);
    if (el) el.textContent = Math.round(weights[k] / tot * 100) + '%';
  });
  const rankEl = document.getElementById('model-rankings');
  if (rankEl) {
    const ranked = scoreRiders(ridersData, weights);
    rankEl.innerHTML = renderModelRankings(ranked);
  }
}

function resetWeights() {
  weights = { ...DEFAULT_WEIGHTS };
  // Update sliders, percentages, and rankings
  const tot = Object.values(weights).reduce((a,b) => a+b, 0) || 1;
  Object.keys(weights).forEach(k => {
    const slider = document.getElementById('wslider-' + k);
    if (slider) slider.value = weights[k];
    const pct = document.getElementById('wpct-' + k);
    if (pct) pct.textContent = Math.round(weights[k] / tot * 100) + '%';
  });
  const rankEl = document.getElementById('model-rankings');
  if (rankEl) {
    const ranked = scoreRiders(ridersData, weights);
    rankEl.innerHTML = renderModelRankings(ranked);
  }
}

function updatePick(idx, val) {
  picks[idx] = val ? Number(val) : null;
  gradeResult = null;
  render();
}

function doGrade() {
  const ranked = scoreRiders(ridersData, DEFAULT_WEIGHTS);
  gradeResult = gradeLineup(picks, ranked);
  render();
}

function requireKey(callback) {
  if (!apiKey) {
    keyCallback = callback || null;
    document.getElementById('key-modal').classList.add('show');
    document.getElementById('key-input').focus();
    return false;
  }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ API INTEGRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handlePull() {
  if (!apiKey) {
    keyCallback = pullFreshIntel;
    document.getElementById('key-modal').classList.add('show');
    document.getElementById('key-input').focus();
    return;
  }
  pullFreshIntel();
}

function submitKey() {
  const val = document.getElementById('key-input').value.trim();
  if (!val) return;
  apiKey = val;
  try { localStorage.setItem('sx_oracle_key', val); } catch(e) {}
  document.getElementById('key-modal').classList.remove('show');
  document.getElementById('key-input').value = '';
  const cb = keyCallback;
  keyCallback = null;
  if (cb) cb();
}

function closeKeyModal() {
  document.getElementById('key-modal').classList.remove('show');
  keyCallback = null;
}

function showLoading(msg) {
  document.getElementById('loading-text').textContent = msg;
  document.getElementById('loading-overlay').classList.add('show');
  document.getElementById('pull-btn').classList.add('loading');
}

function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('show');
  document.getElementById('pull-btn').classList.remove('loading');
}

function setStatus(msg, cls) {
  const el = document.getElementById('pull-status');
  el.textContent = msg;
  el.className = cls || '';
}

async function pullFreshIntel() {
  showLoading('Searching for live Supercross data...');
  setStatus('Pulling...', '');

  const systemPrompt = `You are a Supercross data researcher. Your job is to search the web for the LATEST 2026 Monster Energy Supercross 450SX data and return it as a structured JSON object.

Search for:
1. The most recent round's qualifying results (rider names, qualifying positions, lap times, gaps)
2. Current 450SX championship standings (points)
3. Current injury report (who is out, who is racing hurt)
4. Track/venue information for the upcoming or most recent round
5. Recent race results for the top contenders

You MUST return ONLY a valid JSON object with no other text before or after it. No markdown formatting, no explanation, no backticks. Just raw JSON.

The JSON schema:
{
  "event": {
    "round": <number>,
    "name": "<venue city name, e.g. GLENDALE>",
    "venue": "<stadium name>",
    "city": "<city, state>",
    "date": "<date string>",
    "format": "<Standard Main Event or Triple Crown>",
    "surface": "<surface description>",
    "trackNotes": "<2-3 sentences about track characteristics>",
    "theCall": "<3-5 sentence bold prediction with HTML <strong> tags on key rider names. Written in confident expert analyst voice.>"
  },
  "injuries": {
    "out": [{"rider":"<name>","detail":"<injury and status>"}],
    "hurt": [{"rider":"<name>","detail":"<injury and status>"}]
  },
  "standings": [{"name":"<rider>","pts":<number>}],
  "standingsNote": "<one sentence context>",
  "riders": [
    {
      "id": <1-12>,
      "name": "<full name>",
      "num": <race number>,
      "team": "<team name>",
      "qRank": <qualifying position>,
      "qTime": "<lap time string>",
      "qGap": "<gap to P1 string like +0.3s or FASTEST>",
      "results": [<array of finish positions from 2026 rounds>],
      "pts": <season points>,
      "gHist": <0-10 venue history rating>,
      "start": <0-10 start ability rating>,
      "tFit": <0-10 track fit rating>,
      "health": <0-10 health rating, 10=healthy>,
      "form": <0-10 recent form rating>,
      "historyText": "<1-2 sentences venue history>",
      "notes": "<2-3 sentences expert analyst notes for THIS race. Opinionated, specific, not generic. Reference qualifying data and trends.>",
      "rationale": "<1 punchy sentence prediction rationale>"
    }
  ]
}

Include the top 12 contenders. Rate all variables honestly on 0-10 scale. Write notes in the voice of an expert SX analyst â€” confident, specific, opinionated. Think Jason Thomas or Steve Matthes.

Search multiple sources: supercrosslive.com, racerxonline.com, cyclenews.com, vitalmx.com for the most current data.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 6000,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{
          role: 'user',
          content: 'Search for the latest 2026 Monster Energy Supercross 450SX class data. Find the most recent round\'s qualifying results, current championship standings, injury updates, and track information. Then return the structured JSON as instructed.'
        }],
        system: systemPrompt
      })
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      const msg = err?.error?.message || `API returned ${res.status}`;
      throw new Error(msg);
    }

    const data = await res.json();

    // Extract text content from response
    const textBlocks = data.content.filter(b => b.type === 'text').map(b => b.text);
    const fullText = textBlocks.join('\n');

    // Try to parse JSON from the response
    let parsed = null;
    // Try direct parse first
    try { parsed = JSON.parse(fullText.trim()); } catch(e) {}
    // Try extracting from markdown code blocks
    if (!parsed) {
      const match = fullText.match(/```(?:json)?\s*([\s\S]*?)```/);
      if (match) {
        try { parsed = JSON.parse(match[1].trim()); } catch(e) {}
      }
    }
    // Last resort: find first { to last }
    if (!parsed) {
      const first = fullText.indexOf('{');
      const last = fullText.lastIndexOf('}');
      if (first >= 0 && last > first) {
        try { parsed = JSON.parse(fullText.substring(first, last + 1)); } catch(e) {}
      }
    }

    if (!parsed || !parsed.riders || !Array.isArray(parsed.riders)) {
      throw new Error('Could not parse structured data from response. The AI returned data in an unexpected format.');
    }

    // Update state
    if (parsed.event) {
      eventData = {
        round: parsed.event.round || eventData.round,
        name: (parsed.event.name || eventData.name).toUpperCase(),
        venue: parsed.event.venue || eventData.venue,
        city: parsed.event.city || eventData.city,
        date: parsed.event.date || eventData.date,
        format: parsed.event.format || eventData.format,
        surface: parsed.event.surface || eventData.surface,
        trackNotes: parsed.event.trackNotes || eventData.trackNotes,
        theCall: parsed.event.theCall || eventData.theCall,
        injuriesOut: (parsed.injuries && parsed.injuries.out) || eventData.injuriesOut,
        injuriesHurt: (parsed.injuries && parsed.injuries.hurt) || eventData.injuriesHurt,
        standings: parsed.standings || eventData.standings,
        standingsNote: parsed.standingsNote || eventData.standingsNote
      };
    }

    ridersData = parsed.riders.map((r, i) => ({
      id: r.id || (i + 1),
      name: r.name,
      num: r.num || 0,
      team: r.team || '',
      qRank: r.qRank || (i + 1),
      qTime: r.qTime || 'â€”',
      qGap: r.qGap || 'â€”',
      results: r.results || [],
      pts: r.pts || 0,
      gHist: clamp(r.gHist, 0, 10),
      start: clamp(r.start, 0, 10),
      tFit: clamp(r.tFit, 0, 10),
      health: clamp(r.health, 0, 10),
      form: clamp(r.form, 0, 10),
      historyText: r.historyText || '',
      notes: r.notes || '',
      rationale: r.rationale || ''
    }));

    // Update header
    document.getElementById('hdr-round').textContent = 'ROUND ' + eventData.round;
    document.getElementById('hdr-venue').textContent = eventData.name;

    const now = new Date();
    const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    setStatus('Live data Â· Updated ' + timeStr, 'live');

    // Reset user state
    picks = [null, null, null, null, null];
    gradeResult = null;
    expandedRider = null;
    weights = { ...DEFAULT_WEIGHTS };
    cacheTimestamp = now.getTime();
    hasLiveData = true;

    // Add round to ROUNDS if new
    if (!ROUNDS.find(r => r.num === eventData.round)) {
      ROUNDS.push({ num: eventData.round, name: eventData.name, short: eventData.name.substring(0,3).toUpperCase(), city: eventData.city, date: eventData.date });
      ROUNDS.sort((a, b) => a.num - b.num);
    }

    // Cache data for repeat visits
    saveToCache();

    hideLoading();
    render();

  } catch (err) {
    hideLoading();
    setStatus('Error: ' + err.message, 'error');
    console.error('Pull failed:', err);
    alert('Failed to pull live data:\n\n' + err.message + '\n\nThe baked-in data is still available.');
  }
}

function clamp(val, min, max) {
  if (typeof val !== 'number' || isNaN(val)) return 5;
  return Math.max(min, Math.min(max, val));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ CACHE (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveToCache() {
  try {
    localStorage.setItem('sx_oracle_cache', JSON.stringify({
      v: 3,
      ts: cacheTimestamp,
      key: apiKey,
      eventData: eventData,
      ridersData: ridersData
    }));
  } catch(e) { console.warn('Cache save failed:', e); }
}

function loadFromCache() {
  try {
    // Always restore access code if available
    const savedKey = localStorage.getItem('sx_oracle_key');
    if (savedKey) apiKey = savedKey;

    const raw = localStorage.getItem('sx_oracle_cache');
    if (!raw) return false;
    const cache = JSON.parse(raw);
    if (!cache || cache.v !== 3 || !cache.eventData || !cache.ridersData) return false;

    eventData = cache.eventData;
    ridersData = cache.ridersData;
    apiKey = cache.key || null;
    cacheTimestamp = cache.ts || null;
    hasLiveData = true;

    // Update header
    document.getElementById('hdr-round').textContent = 'ROUND ' + eventData.round;
    document.getElementById('hdr-venue').textContent = eventData.name;

    // Update status
    if (cacheTimestamp) {
      const d = new Date(cacheTimestamp);
      const timeStr = d.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' Â· ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      setStatus('Cached data Â· ' + timeStr, 'live');
    }

    // Add round to ROUNDS if not present
    if (!ROUNDS.find(r => r.num === eventData.round)) {
      ROUNDS.push({ num: eventData.round, name: eventData.name, short: eventData.name.substring(0,3).toUpperCase(), city: eventData.city, date: eventData.date });
      ROUNDS.sort((a, b) => a.num - b.num);
    }

    return true;
  } catch(e) { console.warn('Cache load failed:', e); return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ DATE AWARENESS & HELPER TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseRoundDate(dateStr) {
  // Handles both ISO '2026-02-07' and natural 'February 7, 2026'
  const d = new Date(dateStr);
  return isNaN(d) ? null : d;
}

function formatDate(dateStr) {
  const d = parseRoundDate(dateStr);
  if (!d) return dateStr;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function isRaceDay() {
  try {
    const d = parseRoundDate(eventData.date);
    if (!d) return false;
    const now = new Date();
    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
  } catch(e) { return false; }
}

function getCurrentRound() {
  const now = new Date();
  now.setHours(0,0,0,0);
  // Find the round whose race day is closest to today (within the race week)
  for (let i = ROUNDS.length - 1; i >= 0; i--) {
    const d = parseRoundDate(ROUNDS[i].date);
    if (d && d <= now) return ROUNDS[i];
  }
  return ROUNDS[0];
}

function getNextRound() {
  const now = new Date();
  now.setHours(23,59,59);
  for (let i = 0; i < ROUNDS.length; i++) {
    const d = parseRoundDate(ROUNDS[i].date);
    if (d && d > now) return ROUNDS[i];
  }
  return null;
}

function updateHelperText() {
  const el = document.getElementById('pull-helper');
  if (!el) return;

  if (!hasLiveData) {
    el.textContent = '';
    return;
  }

  const now = new Date();
  const nextRound = getNextRound();
  const currentScheduled = getCurrentRound();

  // Cached data is from a previous round â€” point forward
  if (currentScheduled && eventData.round < currentScheduled.num) {
    el.textContent = `ğŸ“¡ R${currentScheduled.num} ${currentScheduled.name} data available`;
    el.style.color = '#f7c948';
    return;
  }

  // Cached round's race day has passed â€” show next round countdown
  if (eventData.date) {
    const raceDate = parseRoundDate(eventData.date);
    if (raceDate) {
      raceDate.setHours(23, 59, 59);
      if (now > raceDate && nextRound) {
        el.textContent = `Next: R${nextRound.num} ${nextRound.name} Â· ${formatDate(nextRound.date)}`;
        el.style.color = '#555';
        return;
      }
    }
  }

  // It's race day â€” green light
  if (isRaceDay()) {
    el.textContent = 'ğŸ”¥ Race day â€” fresh qualifying available';
    el.style.color = '#06d6a0';
    return;
  }

  // Mid-week with cached data â€” countdown to next qualifying
  if (nextRound) {
    const raceDate = parseRoundDate(nextRound.date);
    if (raceDate) {
      const daysUntil = Math.ceil((raceDate - now) / (24 * 60 * 60 * 1000));
      if (daysUntil <= 2) {
        el.textContent = `ğŸ”¥ R${nextRound.num} qualifying drops ${formatDate(nextRound.date)}`;
        el.style.color = '#06d6a0';
      } else {
        el.textContent = `R${nextRound.num} qualifying drops ${formatDate(nextRound.date)}`;
        el.style.color = '#888';
      }
      return;
    }
  }

  // Fresh data, nothing urgent
  el.textContent = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadFromCache(); // Restore data + access code from previous session
render();
</script>
</body>
</html>
